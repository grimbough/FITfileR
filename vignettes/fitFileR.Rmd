---
title: "Reading FIT files"
author: "Mike Smith"
output: html_document
vignette: |
  %\VignetteIndexEntry{Reading FIT files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_lib}
library(fitFileR)
```

# Reading files

## Example fit files

The package comes with two example fit files, recorded during a ride in early 2017.  They are of the same ride and record the same rider, but the data logging was carried out on two different devices: a Garmin Edge 500 and a TomTom Runner 3.  The files can be found in the `extdata` folder of the package, and identified on your system using the following code. 

```{r data_files}
garmin_file <- system.file("extdata/Garmin.fit", package = "fitFileR")
tomtom_file <- system.file("extdata/TomTom.fit", package = "fitFileR")
```

## Reading

We read files using the function `readFitFile()`.

```{r reading_files}
garmin <- readFitFile(garmin_file)
tomtom <- readFitFile(tomtom_file)
```

The resulting object is a `list` of `tibbles` containing all the data stored in the fit file.

```{r exploring_list}
names(garmin)
```

# Working with the data

The data most often wanted from a fit file are the values such as location, speed, altitude, etc recorded during an activity.  Such data are classed as "records" in the FIT specification and can be retrieved from the FitFile object using using `records()`. 

```{r print_record}
garmin_records <- records(garmin)
garmin_records
```

In this example we actually get a list with three sets of data.  This is because in this particular file there were three distinct definitions of what a "record" contains.  This can happen if data recording begins before a sensor (e.g. a heart rate monitor) has been attached to a device, or GPS position has been acquired.  In this example we are interested in the first entry, which contains the vast majority of the data.

## Plotting a route

To plot locations we extract the longitude and latitude from our FIT records.

```{r process_coords}
library(dplyr)
coords <- garmin_records$record_1 %>% 
  select(position_long, position_lat)
```

We can now use the **leaflet** package to create an interactive map, with our route overlayed on top.

```{r mapping}
library(leaflet)

m <- coords %>% 
  as.matrix() %>%
  leaflet(  ) %>%
     addTiles() %>%
     addPolylines( )
    
m
```

## Comparing heart rates

Here we compare the heart rate recorded during the activity by the two devices.

```{r plot_hr}
tomtom_records <- records(tomtom)

library(ggplot2)
ggplot() + 
    geom_line(data = garmin_records$record_1, aes(x = timestamp, y = heart_rate), col = 1) + 
    geom_line(data = tomtom_records$record_2, aes(x = timestamp, y = heart_rate), col = 2)
```

That's pretty messy as the TomTom data seem to have lots of 255 values (These are presumably dropouts in the data recording that get assigned the maximum value). We can filter those entries out to compare the two traces more easily.

```{r plot-hr-2}
ggplot() + 
    geom_line(data = garmin_records$record_1, aes(x = timestamp, y = heart_rate), col = "blue") + 
    geom_line(data = dplyr::filter(tomtom_records$record_2, heart_rate != 255), 
              aes(x = timestamp, y = heart_rate), col = "red")
```